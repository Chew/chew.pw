<% content_for :meta_tags do %>
  <%= meta_tags title: "#{@away['teamName']} @ #{@home['teamName']} on #{@game['gameData']['datetime']['officialDate']} - MLB Game Breakdown",
                description:
                  "",
                service: "Chew's MLB Stats",
                keywords: "sports mlb baseball #{@away['name']} #{@home['name']}" %>
<% end %>

<h1>Game Information</h1>

<p><%= link_to @away['name'], "/sports/mlb/team/#{@away['id']}" %>
  @ <%= link_to @home['name'], "/sports/mlb/team/#{@home['id']}" %>
  on <%= @game['gameData']['datetime']['officialDate'] %></p>

<p>Game Status: <%= @game['gameData']['status']['detailedState'] %></p>

<p>Score: <%= @game['liveData']['linescore']['teams']['away']['runs'] %>
  - <%= @game['liveData']['linescore']['teams']['home']['runs'] %></p>

<h2>Table of Contents</h2>

<ul>
  <li><%= header_link "Scorecard" %></li>
  <li><%= header_link "Plays Table of Contents" %> - Shows a summary of every batter.</li>
  <li><%= header_link "Plays" %> - A breakdown of every batter.</li>
  <li>Pitching Breakdown - A breakdown of pitches, such as total balls, etc.</li>
</ul>

<h2 id="scorecard">Scorecard</h2>

<label>
  Showing:
  <select id="scorecard-type">
    <option value="0">Runs</option>
    <option value="1">Hits</option>
    <option value="2">Errors</option>
    <option value="3">Left On Base</option>
  </select>
</label>
<table class="table">
  <thead>
  <tr>
    <th>Team</th>
    <% total_innings(@game).times do |i| %>
      <th><%= i + 1 %></th>
    <% end %>
    <th>R</th>
    <th>H</th>
    <th>E</th>
    <th>LOB</th>
  </tr>
  </thead>
  <tbody>
  <% %w[away home].each do |team| %>
    <tr>
      <td><%= instance_variable_get("@#{team}")['teamName'] %></td>
      <% @game['liveData']['linescore']['innings'].each do |inning| %>
        <td id="<%= "#{team}-#{inning}" %>" class="valued-inning">
          <span class="shown-value"><%= inning[team]['runs'] || 0 %></span>
          <span class="extra-data visually-hidden"><%= inning[team].map {|_, v| v }.join(',') %></span>
        </td>
      <% end %>
      <% (9 - @game['liveData']['linescore']['currentInning']).times do |_| %>
        <td>-</td>
      <% end %>
      <% @game['liveData']['linescore']['teams'][team].each do |_, amount| %>
        <td><b><%= amount %></b></td>
      <% end %>
    </tr>
  <% end %>
  </tbody>
</table>

<!--<h3>Game Progress Graph</h3>-->

<span id="home-info" class="visually-hidden"><%= @inning_info['home'].join('/') %></span>
<span id="away-info" class="visually-hidden"><%= @inning_info['away'].join('/') %></span>

<!--<canvas id="progress-graph" width="800" height="400"></canvas>-->

<h2 id="<%= "Plays Table of Contents".parameterize %>">Plays Table of Contents</h2>

<ol>
  <% @game['liveData']['linescore']['currentInning'].times do |i| %>
    <li><%= (i + 1).ordinalize %> Inning</li>
    <ul>
      <li>Top</li>
      <ul>
        <% plays = @game['liveData']['plays']['playsByInning'][i]['top'] %>
        <% @game['liveData']['plays']['allPlays'][plays.min..plays.max].each_with_index do |play, ind| %>
          <% play['playEvents'].each do |event| %>
            <% next if event['details']['eventType'].nil? %>
            <li><i><%= event['details']['description'] %></i></li>
          <% end %>
          <li><%= link_to play['result']['description'] || "#{play['matchup']['batter']['fullName']} is at bat.", "#play-#{plays[ind]}" %></li>
        <% end %>
      </ul>
      <% if @game['liveData']['linescore']['currentInning'] > (i + 1) or (@game['liveData']['linescore']['currentInning'] == i + 1 and @game['liveData']['linescore']['inningState'] == "Bottom") %>
        <li>Bottom</li>
        <ul>
          <% plays = @game['liveData']['plays']['playsByInning'][i]['bottom'] %>
          <% @game['liveData']['plays']['allPlays'][plays.min..plays.max].each_with_index do |play, ind| %>
            <% play['playEvents'].each do |event| %>
              <% next if event['details']['eventType'].nil? %>
              <li><i><%= event['details']['description'] %></i></li>
            <% end %>
            <li><%= link_to play['result']['description'] || "#{play['matchup']['batter']['fullName']} is at bat.", "#play-#{plays[ind]}" %></li>
          <% end %>
        </ul>
      <% end %>
    </ul>
  <% end %>
</ol>

<h2 id="plays">Plays</h2>

<% @game['liveData']['linescore']['currentInning'].times do |i| %>
  <h3><%= (i + 1).ordinalize %> Inning</h3>

  <hr>

  <h4>Top</h4>

  <%
    plays_inning = @game['liveData']['plays']['playsByInning'][i]
    first_bottom = plays_inning['bottom'][0]
    start_index = plays_inning['startIndex']
    end_index = plays_inning['endIndex']
  %>
  <div class="row">
    <% @game['liveData']['plays']['allPlays'][start_index..end_index].each_with_index do |play, ind| %>
      <% if first_bottom == start_index + ind %>
        </div>
        <hr>
        <h4>Bottom</h4>
        <div class="row">
      <% end %>
      <div class="col-md-3" id="play-<%= ind + start_index %>">
        <div class="card">
          <!--      <img src="..." class="card-img-top" alt="...">-->
          <div class="card-body">
            <h5 class="card-title"><%= play['result']['description'] || "#{play['matchup']['batter']['fullName']} is at bat." %></h5>

            <p class="card-text">Event: <%= play['result']['event'] %></p>
            <p class="card-text">Score: <%= play['result']['awayScore'] %> - <%= play['result']['homeScore'] %></p>

            <p class="card-text">Play Events:</p>
            <ol>
              <% hit_data = nil %>
              <% play['playEvents'].each do |event| %>
                <% next unless event['isPitch'] or event['type'] == 'pickoff' %>
                <li <% if event['type'] == 'pickoff' %> class="not-play" <% else %> value="<%= event['pitchNumber'] %>" <% end %>>
                  <span class="<%= play_class event %>"><%= event['details']['description'] %></span></li>
                <% unless event['hitData'].nil? %>
                  <% hit_data = event['hitData'] %>
                <% end %>
              <% end %>
            </ol>
          </div>
          <div class="card-footer">
            <small class="text-muted">P: <%= play['matchup']['pitcher']['fullName'] %></small>
            <% if hit_data %>
              <small class="text-muted">
                <br><i>Ball left the bat at a speed of <%= hit_data['launchSpeed'] %> mph
                at a <%= hit_data['launchAngle'] %>&deg; angle, and travelled <%= hit_data['totalDistance'] %> feet.</i>
              </small>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
    </div>

    <hr>
<% end %>

<h2>Pitch Breakdown</h2>

<h3>Batting Results</h3>

<p>The end result of a given batting cycle, based on the pitcher.</p>

<table class="table">
  <thead>
  <tr>
    <th>Pitch Type</th>
    <% @pitchers.each do |pitcher| %>
      <th><%= pitcher.split(' ').last %></th>
    <% end %>
    <th>Amount</th>
  </tr>
  </thead>
  <tbody>
  <% @results.each do |kind, amount| %>
    <tr>
      <td><%= kind %></td>
      <% @pitchers.each do |pitcher| %>
        <td><%= @results_by_pitcher[pitcher][kind] || 0 %></td>
      <% end %>
      <td><%= amount %></td>
    </tr>
  <% end %>
  </tbody>
</table>

<h3>Types of Pitches</h3>

<p><i>Note: In the rare occurrence a pitcher is switched out mid-at-bat, the prior pitcher's throws will be counted
  towards the relief-pitcher.</i></p>

<table class="table">
  <thead>
  <tr>
    <th>Pitch Type</th>
    <% @pitchers.each do |pitcher| %>
      <th><%= pitcher.split(' ').last %></th>
    <% end %>
    <th>Amount</th>
  </tr>
  </thead>
  <tbody>
  <% @pitches.sort.each do |kind, amount| %>
    <tr>
      <td><%= kind %></td>
      <% @pitchers.each do |pitcher| %>
        <td><%= @pitches_by_pitcher[pitcher][kind] || 0 %></td>
      <% end %>
      <td><%= amount %></td>
    </tr>
  <% end %>
  </tbody>
</table>

<% content_for :extra_foot do %>
  <%= javascript_pack_tag "sports/game_charts" %>
<% end %>