<% content_for :meta_tags do %>
  <%= meta_tags title: "#{@away['teamName']} @ #{@home['teamName']} on #{@game['gameData']['datetime']['officialDate']} - MLB Game Breakdown",
                description:
                  "View the breakdown of the #{@away['teamName']} @ #{@home['teamName']} game on #{@game['gameData']['datetime']['officialDate']}. View each play, pitch breakdown, umpire blunders, and more.",
                service: "Chew's MLB Stats",
                keywords: "sports mlb baseball #{@away['name']} #{@home['name']}" %>
<% end %>

<h1>Game Information</h1>

<p><%= link_to @away['name'], "/sports/mlb/team/#{@away['id']}" %>
  @ <%= link_to @home['name'], "/sports/mlb/team/#{@home['id']}" %>
  on <%= @game['gameData']['datetime']['officialDate'] %></p>

<p>Game Status: <%= game_status @game %></p>

<p>Score: <%= @game['liveData']['linescore']['teams']['away']['runs'] %>
  - <%= @game['liveData']['linescore']['teams']['home']['runs'] %></p>

<h2>Table of Contents</h2>

<ul>
  <li><%= header_link "Scorecard" %></li>
  <li><%= header_link "Plays Table of Contents" %> - Shows a summary of every batter.</li>
  <li><%= header_link "Plays" %> - A breakdown of every batter.</li>
  <li><%= header_link "Pitch Breakdown" %> - A breakdown of pitches, such as total balls, etc.</li>
  <li><%= header_link "Umpire Blunders" %> - Find all the missed balls/strikes! (BETA)</li>
</ul>

<h2 id="scorecard">Scorecard</h2>

<label>
  Showing:
  <select id="scorecard-type">
    <option value="0">Runs</option>
    <option value="1">Hits</option>
    <option value="2">Errors</option>
    <option value="3">Left On Base</option>
  </select>
</label>
<%= render partial: 'scorecard', locals: { game: @game['liveData']['linescore'], home: @home, away: @away, state: game_status(@game) } %>

<!--<h3>Game Progress Graph</h3>-->

<span id="home-info" class="visually-hidden"><%= @inning_info['home'].join('/') %></span>
<span id="away-info" class="visually-hidden"><%= @inning_info['away'].join('/') %></span>

<!--<canvas id="progress-graph" width="800" height="400"></canvas>-->

<h2 id="<%= "Plays Table of Contents".parameterize %>">Plays Table of Contents</h2>

<ol>
  <% (@game['liveData']['linescore']['currentInning'] || 0).times do |i| %>
    <li><%= (i + 1).ordinalize %> Inning</li>
    <ul>
      <li>Top</li>
      <ul>
        <% plays = @game['liveData']['plays']['playsByInning'][i]['top'] %>
        <% @game['liveData']['plays']['allPlays'][plays.min..plays.max].each_with_index do |play, ind| %>
          <% play['playEvents'].each do |event| %>
            <% next if event['details']['eventType'].nil? %>
            <li><i><%= event['details']['description'] %></i></li>
          <% end %>
          <li><%= link_to play['result']['description'] || "#{play['matchup']['batter']['fullName']} is at bat.", "#play-#{plays[ind]}" %></li>
        <% end %>
      </ul>
      <% if @game['liveData']['linescore']['currentInning'] > (i + 1) or (@game['liveData']['linescore']['currentInning'] == i + 1 and @game['liveData']['linescore']['inningHalf'] == "Bottom") %>
        <li>Bottom</li>
        <ul>
          <% plays = @game['liveData']['plays']['playsByInning'][i]['bottom'] %>
          <% @game['liveData']['plays']['allPlays'][plays.min..plays.max].each_with_index do |play, ind| %>
            <% play['playEvents'].each do |event| %>
              <% next if event['details']['eventType'].nil? %>
              <li><i><%= event['details']['description'] %></i></li>
            <% end %>
            <li><%= link_to play['result']['description'] || "#{play['matchup']['batter']['fullName']} is at bat.", "#play-#{plays[ind]}" %></li>
          <% end %>
        </ul>
      <% end %>
    </ul>
  <% end %>
</ol>

<h2 id="plays">Plays</h2>

<% (@game['liveData']['linescore']['currentInning'] || 0).times do |i| %>
  <h3><%= (i + 1).ordinalize %> Inning</h3>

  <hr>

  <h4>Top</h4>

  <%
    plays_inning = @game['liveData']['plays']['playsByInning'][i]
    first_bottom = plays_inning['bottom'][0]
    start_index = plays_inning['startIndex']
    end_index = plays_inning['endIndex']
  %>
  <div class="row">
    <% last_out = 0 %>
    <% @game['liveData']['plays']['allPlays'][start_index..end_index].each_with_index do |play, ind| %>
      <% if first_bottom == start_index + ind %>
        </div>
        <hr>
        <h4>Bottom</h4>
        <div class="row">
        <% last_out = 0 %>
      <% end %>
      <div class="col-md-3" id="play-<%= ind + start_index %>">
        <div class="card">
          <!--      <img src="..." class="card-img-top" alt="...">-->
          <div class="card-body">
            <h5 class="card-title"><%= play['result']['description'] || "#{play['matchup']['batter']['fullName']} is at bat." %></h5>

            <p class="card-text">
              Event: <%= play['result']['event'] || "Pending..." %><br>
              Score: <%= play['result']['awayScore'] %> - <%= play['result']['homeScore'] %><br>
              Outs: <%= play['count']['outs'] %> <% if play['count']['outs'] - last_out > 0 %> (+<%= play['count']['outs'] - last_out %>)<% end %>
              <% last_out = play['count']['outs'] %>
            </p>

            <span class="card-text">Play Events:</span>
            <ol>
              <% play['playEvents'].each_with_index do |event, pe_index| %>
                <% next unless event['isPitch'] or event['type'] == 'pickoff' %>
                <li <% if event['type'] == 'pickoff' %> class="not-play" <% else %> value="<%= event['pitchNumber'] %>" <% end %>>
                  <a class="<%= play_class event %>" data-bs-toggle="collapse" href="#<%= "play-#{ind + start_index}-pitch-#{pe_index}" %>" role="button" aria-expanded="false" aria-controls="<%= "play-#{ind + start_index}-pitch-#{pe_index}" %>">
                    <%= event['details']['description'] %>
                    <% if bad_call?(event) %>
                      <span class="<%= event['details']['isStrike'] ? "ball" : "strike" %>" data-bs-toggle="tooltip"
                            title="Ball was <%= in_the_zone?(event['pitchData'])[0] ? "in" : "out of" %> the zone">
                        <i class="fa-solid fa-circle-exclamation"></i>
                      </span>
                    <% end %>
                  </a>
                </li>
                <div class="collapse no-list-type" id="<%= "play-#{ind + start_index}-pitch-#{pe_index}" %>">
                  <div class="card card-body">
                    <% if event['type'] == 'pickoff' %>
                      Pick-off attempts do not have pitch data :(
                    <% elsif event['details']['description'] == "Automatic Ball" %>
                      Automatic Balls are not pitches, so there is no pitch data.
                    <% else %>
                      Count: <%= event['count']['balls'] %> - <%= event['count']['strikes'] %>
                      <hr>
                      <% if event['details']['type'] %>
                        Type: <%= event['details']['type']['description'] %>
                        <br>
                      <% end %>
                      Speed: <%= event['pitchData']['startSpeed'] %>mph -> <%= event['pitchData']['endSpeed'] %>mph.
                      <br>
                      Break Angle: <%= event['pitchData']['breaks']['breakAngle'] %>&deg;.
                      <br>
                      <% if event['pitchData']['breaks']['breakLength'] %>
                        Break Length: <%= event['pitchData']['breaks']['breakLength'] %>ft.
                        <br>
                      <% end %>
                      <% if event['pitchData']['breaks']['spinRate'] %>
                        Spin Rate: <%= event['pitchData']['breaks']['spinRate'] %>rpm.
                        <br>
                      <% end %>
                      <% if event['pitchData']['breaks']['spinDirection'] %>
                        Spin Direction: <%= event['pitchData']['breaks']['spinDirection'] %>&deg;.
                      <% end %>

                      <% if event['hitData'] %>
                        <hr>
                        Ball left the bat at a speed of <%= event['hitData']['launchSpeed'] %> mph
                        at a <%= event['hitData']['launchAngle'] %>&deg; angle, and travelled <%= event['hitData']['totalDistance'] %> feet.
                      <% end %>

                      <% unless event['pitchData']['coordinates'].empty? %>
                        <hr>
                        Plate Position: (<%= event['pitchData']['coordinates']['pX'] %>, <%= event['pitchData']['coordinates']['pZ'] %>)
                        <br>
                        <div class="d-inline">
                          In the zone?
                          <% if in_the_zone?(event['pitchData'])[0] == true and event['details']['call']['description'].start_with? "Ball" %>
                            <span class="strike"><i class="fas fa-xmark"></i> Yes</span>
                          <% elsif in_the_zone?(event['pitchData'])[0] == false and event['details']['call']['description'].start_with? "Ball" %>
                            <span class="ball"><i class="fas fa-check"></i> No</span>
                          <% elsif in_the_zone?(event['pitchData'])[0] == true and event['details']['call']['description'] == "Called Strike" %>
                            <span class="ball"><i class="fas fa-check"></i> Yes</span>
                          <% elsif in_the_zone?(event['pitchData'])[0] != true and event['details']['call']['description'] == "Called Strike" %>
                            <span class="strike"><i class="fas fa-xmark"></i> No, <%= in_the_zone?(event['pitchData'])[1] %></span>
                          <% else %>
                            <%= in_the_zone?(event['pitchData'])[0] == true ? "Yes" : "No" %>
                          <% end %>
                        </div>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </ol>
            <span class="card-text">Position Changes:</span>
            <ul>
              <% reaches = 0 %>
              <% play['runners'].sort_by {|e| e['movement']['start'] || "0B"}.each do |runner| %>
                <% next if runner['movement']['start'] == runner['movement']['end'] %>
                <% reaches += 1 %>
                <li><%= runner['details']['runner']['fullName'] %> (<%= runner['movement']['start'] || "none" %> -> <%= runner['movement']['end'] || "out" %>)</li>
              <% end %>
              <% if reaches.zero? %>
                <li>No position changes</li>
              <% end %>
            </ul>
          </div>
          <div class="card-footer">
            <small class="text-muted">P: <%= play['matchup']['pitcher']['fullName'] %></small>
          </div>
        </div>
      </div>
    <% end %>
    </div>

    <hr>
<% end %>

<h2 id="pitch-breakdown">Pitch Breakdown</h2>

<h3>Batting Results</h3>

<p>The end result of a given batting cycle, based on the pitcher.</p>

<div class="table-responsive">
<table class="table">
  <thead>
  <tr>
    <th>Pitch Type</th>
    <% @pitchers.each do |pitcher| %>
      <th><%= pitcher.split(' ').last %></th>
    <% end %>
    <th>Amount</th>
  </tr>
  </thead>
  <tbody>
  <% @results.each do |kind, amount| %>
    <tr>
      <td><%= kind %></td>
      <% @pitchers.each do |pitcher| %>
        <td><%= @results_by_pitcher[pitcher][kind] || 0 %></td>
      <% end %>
      <td><%= amount %></td>
    </tr>
  <% end %>
  </tbody>
</table>
</div>

<h3>Types of Pitches</h3>

<p><i>Note: In the rare occurrence a pitcher is switched out mid-at-bat, the prior pitcher's throws will be counted
  towards the relief-pitcher.</i></p>

<div class="table-responsive">
<table class="table">
  <thead>
  <tr>
    <th>Pitch Type</th>
    <% @pitchers.each do |pitcher| %>
      <th><%= pitcher.split(' ').last %></th>
    <% end %>
    <th>Amount</th>
  </tr>
  </thead>
  <tbody>
  <% @pitches.sort.each do |kind, amount| %>
    <tr>
      <td><%= kind %></td>
      <% @pitchers.each do |pitcher| %>
        <td><%= @pitches_by_pitcher[pitcher][kind] || 0 %></td>
      <% end %>
      <td><%= amount %></td>
    </tr>
  <% end %>
  </tbody>
  <tfoot>
  <tr>
    <td>Total (Excl. Pick-off Attempts)</td>
    <% @pitchers.each do |pitcher| %>
      <td><%= @pitches_by_pitcher[pitcher].sum {|e, i| e.include?("Pickoff") ? 0 : i} %></td>
    <% end %>
    <td><%= @pitches.sum {|e, i| e.include?("Pickoff") ? 0 : i} %></td>
  </tr>
  </tfoot>
</table>
</div>

<h2 id="umpire-blunders">Umpire Blunders <span class="badge bg-secondary">Beta</span></h2>

<p>A breakdown of all balls and called strikes to determine if they were accurate or not.</p>

<p><i>
  Note: As I have to draw the strike-zone myself, these may be inaccurate. If it is, let me know!
</i></p>

<p>This game's <abbr title="Home Plate">HP</abbr> Umpire: <%= @umpire %></p>

<h3>Balls</h3>

<p>Of the <%= @total_balls %> balls, <%= @blunder_balls.count %> were actually in the zone:</p>
<ol>
  <% @blunder_balls.each do |blunder| %>
    <li><%= blunder %></li>
  <% end %>
</ol>

<h3>Strikes</h3>

<p>Of the <%= @total_strikes %> called strikes, <%= @blunder_strikes.count %> were actually out of the zone:</p>
<ol>
  <% @blunder_strikes.each do |blunder| %>
    <li><%= blunder %></li>
  <% end %>
</ol>

<% content_for :extra_foot do %>
  <%= javascript_pack_tag "sports/game_charts" %>
<% end %>